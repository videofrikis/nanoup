<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>RECARGAR LISTA DE CANALES EN NANOMID</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.4;
      background: #fff; color: #111;
      display: grid; place-items: start center; padding: 24px;
    }
    .wrap { width: 100%; max-width: 560px; }
    .card { background: #fff; border-radius: 16px; border: 1px solid #eee; box-shadow: 0 6px 20px rgba(0,0,0,.05); overflow: hidden; }
    .card-header { padding: 18px 20px; border-bottom: 1px solid #eee; }
    .title { margin: 0; font-size: 1.15rem; font-weight: 800; text-align:center; }
    .subtitle { margin: 6px 0 0; color: #5a5a5a; font-size: .95rem; text-align:center; }
    .logo { display:flex; justify-content:center; margin-top: 12px; }
    .logo img { max-width: 100%; height:auto; max-height: 120px; }
    .card-body { padding: 20px; }
    form { display: grid; gap: 14px; }
    .field { display: grid; gap: 6px; }
    label { font-weight: 650; font-size: .95rem; }
    input { width: 100%; padding: 12px 14px; border: 1px solid #dcdcdc; border-radius: 12px; font-size: 15px; }
    input:focus { outline: none; border-color: #111; box-shadow: 0 0 0 4px rgba(0,0,0,.06); }
    .actions { margin-top: 8px; }
    button { width: 100%; padding: 14px 16px; border: 0; border-radius: 12px; font-weight: 800; font-size: 15px; background: #111; color: #fff; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,.12); }

    .warn-red { margin: 6px 0 0; color: #b00020; font-size: .82rem; }
    .otp-block { margin-top: 18px; text-align:center; }
    .otp-title { font-weight: 800; margin: 0 0 8px; }
    .otp-img img { max-width: 100%; height: auto; border-radius: 12px; border:1px solid #eee; }
    .notice { margin-top: 16px; border: 1px solid #eee; background:#fafafa; border-radius: 12px; padding: 14px; }
    .ok { color: #0a7c39; } .err { color: #b00020; }
    .catalogo { margin-top: 14px; text-align: center; }
    .catalogo a { display: inline-block; padding: 12px 18px; border-radius: 12px; font-weight: 800; font-size: 15px; text-decoration: none; background: #111; color: #fff; box-shadow: 0 6px 16px rgba(0,0,0,.12); }
    .catalogo a:hover { transform: translateY(-1px); } .catalogo a:active { transform: translateY(0); }
    .cta-shop { margin-top: 18px; text-align: center; }
    .btn-green { display: inline-block; width: 100%; padding: 12px 18px; border-radius: 12px; font-weight: 800; font-size: 15px; text-decoration: none; background: #16a34a; color: #fff; box-shadow: 0 6px 16px rgba(0,0,0,.12); }
    .btn-green + .btn-green { margin-top: 10px; }
    .mini-note { margin-top: 8px; font-size: .85rem; color: #555; line-height: 1.35; text-align:left; }

    @media (max-width: 480px) {
      body { padding: 16px; } .title { font-size: 1.05rem; }
      button, .btn-green { font-size: 14px; } .mini-note { font-size: .84rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-header">
        <h1 class="title">RECARGAR LISTA DE CANALES EN NANOMID</h1>
        <p class="subtitle">Introduce tu <b>ID</b> (nº de pedido) y tu <b>CÓDIGO OTP</b> tal como aparece en tu app Nanomid.</p>
        <div class="logo"><img src="https://nanomid.com/_next/static/media/iconPlayer.493c21e3.png" alt="Nanomid" /></div>
      </div>

      <div class="card-body">
        <form id="f" novalidate>
          <div class="field">
            <label for="orderId">ID (nº de pedido)</label>
            <input id="orderId" name="orderId" type="text" autocomplete="off" placeholder="Ej: 12345" required />
          </div>
          <div class="field">
            <label for="quickCode">CÓDIGO OTP</label>
            <input id="quickCode" name="quickCode" type="text" autocomplete="one-time-code" placeholder="Ej: ABCDEF" maxlength="64" required />
          </div>

          <p class="warn-red">Para dispositivos móviles con app NANOMID, utiliza otro dispositivo para abrir esta página y poder cargar la lista de canales. Es necesario que la app esté abierta.</p>

          <div class="actions"><button id="btn" type="submit">Recargar</button></div>
        </form>

        <div id="out" class="notice" hidden>
          <div id="status"></div>
          <div id="tpl" class="template"></div>
          <pre id="details" style="display:none"></pre>
        </div>

        <div class="cta-shop">
          <a class="btn-green" href="https://api.whatsapp.com/send/?phone=447537133910&text&type=phone_number&app_absent=0" target="_blank" rel="noopener">COMPRAR LISTA DE CANALES</a>
          <a class="btn-green" href="https://nanomid.com/en/player/active-licence" target="_blank" rel="noopener">COMPRAR LICENCIA DE LA APP</a>
          <div class="mini-note">
            SAMSUNG / LG <b>9,99€</b> / de por vida<br>
            ANDROID <b>2,49€</b> / de por vida<br>
            iOS Apple <b>4,99€</b> / de por vida<br>
            <em>* La app es gratuita en algunos dispositivos durante los primeros 14 días. Una vez transcurridos, aparecerá el OTP con un código QR en la pantalla para que lo escanees con el móvil y realices el pago de la app.</em>
          </div>
        </div>

        <div class="cta-shop" style="margin-top:18px;">
          <a class="btn-green" href="https://nanomid.com/en/vpn/buy" target="_blank" rel="noopener">COMPRAR VPN NANOMID</a>
          <div class="mini-note">En la web oficial de Nanomid tienes disponibles varios paquetes:<br>1 Mes / 2 €<br>3 Meses / 4 €<br>6 Meses / 6 €<br>12 Meses / 10 €<br>24 Meses / 14 €</div>
        </div>

        <div class="otp-block">
          <p class="otp-title">VER CÓDIGO OTP EN TV</p>
          <p style="text-align:left; margin:6px 0 12px;">Para ver el código OTP en la TV, habitualmente aparece solo si no tienes licencia o lista de canales activa. Si no aparece, mantén pulsado <b>OK</b> en la pantalla principal y después pulsa el botón <b>VERDE</b> (o la flecha indicada en tu pantalla).</p>
          <div class="otp-img"><img src="https://nanomid.com/_next/static/media/scan1.1c958ff7.gif" alt="Ver código OTP en TV" /></div>
          <div class="catalogo"><a href="https://elitesatstream.kyte.site/es" target="_blank" rel="noopener">CATÁLOGO ONLINE</a></div>
        </div>
      </div>
    </div>

    <div class="footer">Contacto: <a href="https://elitesatstream.kyte.site/es" target="_blank" rel="noopener">https://elitesatstream.kyte.site/es</a></div>
  </div>

  <!-- Config del backend (TU Web App y token) -->
  <script>
    const SCRIPT_URL   = 'https://script.google.com/macros/s/AKfycbyrg7iGmvwH0RDIwWsz_y0sWjyKfQ7enJAXusQ53aHLBq7vB6XVoD_0XgWH6Pwt9srl/exec';
    const PUBLIC_TOKEN = 's3cr3t_123';
  </script>

  <!-- JS: llamar a Apps Script con fetch (NO google.script.run) -->
<script>
  const SCRIPT_URL   = 'https://script.google.com/macros/s/AKfycbyrg7iGmvwH0RDIwWsz_y0sWjyKfQ7enJAXusQ53aHLBq7vB6XVoD_0XgWH6Pwt9srl/exec';
  const PUBLIC_TOKEN = 's3cr3t_123';

  const form = document.getElementById('f');
  const btn = document.getElementById('btn');
  const out = document.getElementById('out');
  const statusEl = document.getElementById('status');
  const tplEl = document.getElementById('tpl');
  const detailsEl = document.getElementById('details');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const orderId = document.getElementById('orderId').value.trim();
    const quickCode = document.getElementById('quickCode').value.trim();
    if (!orderId || !quickCode) return;

    btn.disabled = true; btn.textContent = 'Procesando…';
    out.hidden = true; statusEl.textContent = ''; statusEl.className = '';
    tplEl.innerHTML = ''; detailsEl.style.display = 'none'; detailsEl.textContent = '';

    try {
      // Evita preflight: text/plain es "simple"
      const resp = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify({ orderId, quickCode, token: PUBLIC_TOKEN })
      });

      // Si por lo que sea no viene JSON (p.ej. HTML), muéstralo en texto
      const raw = await resp.text();
      let data;
      try { data = JSON.parse(raw); } catch { data = { ok:false, error:'Respuesta no JSON', raw }; }

      btn.disabled = false; btn.textContent = 'Recargar'; out.hidden = false;

      if (data && data.ok) {
        statusEl.className = 'ok';
        statusEl.textContent = '✅ Lista de canales cargada correctamente.';
        const p = data.order || {};
        const dias = Number(p.diasRestantes);
        const RENEW_URL = 'https://bit.ly/m/elitesatstream';
        let duracionHtml = '';
        if (!isNaN(dias) && dias <= 0) {
          duracionHtml = `
            <p><b>Duración restante:</b> <span class="expired">CADUCADO</span></p>
            <p class="renew">Puedes renovar tu lista de canales escribiendo
              <a href="${RENEW_URL}" target="_blank" rel="noopener">AQUÍ</a>.
            </p>`;
        } else if (!isNaN(dias)) {
          duracionHtml = `<p><b>Duración restante:</b> ${dias} día${dias===1?'':'s'}</p>`;
        }
        tplEl.innerHTML = [
          `<p><b>Número de pedido:</b> ${p.id ?? ''}</p>`,
          `<p><b>PRODUCTO:</b> ${p.servicio ?? ''}</p>`,
          `<p><b>USUARIO:</b> ${p.usuario ?? ''}</p>`,
          `<p><b>ALTA:</b> ${p.alta ?? ''}</p>`,
          `<p><b>BAJA:</b> ${p.baja ?? ''}</p>`,
          duracionHtml
        ].join('');
        form.reset();
      } else {
        statusEl.className = 'err';
        statusEl.textContent = '❌ Error al recargar';
        detailsEl.style.display = 'block';
        detailsEl.textContent = data.error || data.raw || 'Fallo desconocido.';
      }
    } catch (err) {
      btn.disabled = false; btn.textContent = 'Recargar'; out.hidden = false;
      statusEl.className = 'err';
      statusEl.textContent = '❌ Error de red';
      detailsEl.style.display = 'block';
      detailsEl.textContent = String(err);
    }
  });
</script>
</body>
</html>
